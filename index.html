<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piped MSX Player</title>
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            overflow: hidden;
        }
        /* Status Bar */
        #status {
            position: fixed; top: 20px; right: 40px;
            font-size: 12px; color: #888;
            z-index: 50;
        }
        /* Grid Layout */
        #grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 25px;
            padding: 60px 40px;
            height: 100vh;
            box-sizing: border-box;
        }
        /* Video Card */
        .card {
            background: #1e1e1e;
            border: 4px solid transparent;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            transition: transform 0.15s ease, border-color 0.15s;
            position: relative;
        }
        .card:focus {
            border-color: #3ea6ff;
            transform: scale(1.05);
            outline: none;
            background: #2a2a2a;
            z-index: 10;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .thumb-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            overflow: hidden;
            border-radius: 8px 8px 0 0;
            background: #000;
        }
        .card img {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
        }
        .duration {
            position: absolute;
            bottom: 8px; right: 8px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .info {
            padding: 12px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .title {
            font-size: 16px;
            font-weight: 600;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.3;
        }
        .channel {
            margin-top: 8px;
            font-size: 13px;
            color: #aaa;
        }

        /* Player Overlay */
        #player {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            display: none;
            z-index: 100;
        }
        video { width: 100%; height: 100%; outline: none; }
        
        /* Loading/Error State */
        #loader {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            text-align: center;
        }
    </style>
</head>
<body>

<div id="status">Connecting...</div>
<div id="loader">Loading Trending...</div>
<div id="grid"></div>

<div id="player">
    <video id="videoElement" controls></video>
</div>

<script>
    // --- CONFIGURATION ---
    const PROXY = 'https://corsproxy.io/?'; // Fixes CORS issues
    const REGION = 'US';
    
    // List of APIs to try in order (Availability varies)
    const API_LIST = [
        'https://pipedapi.kavin.rocks',
        'https://piped-api.privacy.com.de',
        'https://api.piped.pw',
        'https://pipedapi.r4fo.com'
    ];

    let currentApiIndex = 0;
    let activeApi = '';
    let videos = [];
    let isPlaying = false;

    // --- 1. ROBUST FETCH (Auto-Retry + Proxy) ---
    async function robustFetch(endpoint) {
        const target = activeApi + endpoint;
        
        // Attempt 1: Direct Access
        try {
            const res = await fetch(target);
            if(res.ok) return await res.json();
        } catch(e) { console.warn(`Direct access failed for ${target}`); }

        // Attempt 2: Via Proxy
        try {
            console.log(`Trying proxy for ${target}`);
            const res = await fetch(PROXY + encodeURIComponent(target));
            if(res.ok) return await res.json();
        } catch(e) { console.warn(`Proxy failed for ${target}`); }

        throw new Error("Fetch failed");
    }

    // --- 2. INITIALIZATION ---
    async function init() {
        const status = document.getElementById('status');
        const loader = document.getElementById('loader');
        
        // Cycle through APIs until one works
        for (let i = 0; i < API_LIST.length; i++) {
            activeApi = API_LIST[i];
            status.innerText = `Trying: ${activeApi.replace('https://', '')}`;
            try {
                // Test fetch trending
                videos = await robustFetch(`/trending?region=${REGION}`);
                status.innerText = `Connected: ${activeApi.replace('https://', '')}`;
                loader.style.display = 'none';
                render();
                return; // Success!
            } catch (e) {
                console.error(`API ${activeApi} failed.`);
            }
        }
        
        loader.innerHTML = "âŒ All APIs Failed.<br>Try reloading later.";
    }

    // --- 3. RENDER UI ---
    function render() {
        const grid = document.getElementById('grid');
        grid.innerHTML = videos.map((v, i) => {
            // Piped sometimes returns slightly different ID formats
            const id = v.url.split('=')[1] || v.url.split('/').pop();
            const duration = formatDuration(v.duration);
            
            return `
            <div class="card" tabindex="0" data-id="${id}">
                <div class="thumb-container">
                    <img src="${v.thumbnail}" loading="lazy" alt="">
                    <div class="duration">${duration}</div>
                </div>
                <div class="info">
                    <div class="title">${v.title}</div>
                    <div class="channel">${v.uploaderName}</div>
                </div>
            </div>
            `;
        }).join('');
        
        // Focus first item
        if (grid.children.length > 0) grid.children[0].focus();
    }

    // Helper: Format seconds to MM:SS
    function formatDuration(seconds) {
        if(!seconds) return "";
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m}:${s < 10 ? '0' : ''}${s}`;
    }

    // --- 4. SPATIAL NAVIGATION (Remote Control) ---
    document.addEventListener('keydown', (e) => {
        if (isPlaying) {
            handlePlayerKeys(e);
            return;
        }

        const focused = document.activeElement;
        if (!focused.classList.contains('card')) return;

        const cards = Array.from(document.querySelectorAll('.card'));
        const index = cards.indexOf(focused);
        const cols = 4; // Matches CSS Grid

        if (index === -1) return;

        switch(e.key) {
            case 'ArrowRight': 
                if(index + 1 < cards.length) cards[index + 1].focus(); 
                break;
            case 'ArrowLeft': 
                if(index - 1 >= 0) cards[index - 1].focus(); 
                break;
            case 'ArrowDown': 
                if(index + cols < cards.length) cards[index + cols].focus(); 
                break;
            case 'ArrowUp': 
                if(index - cols >= 0) cards[index - cols].focus(); 
                break;
            case 'Enter': 
                playVideo(focused.dataset.id); 
                break;
        }
    });

    // --- 5. PLAYER LOGIC ---
    async function playVideo(id) {
        const player = document.getElementById('player');
        const videoEl = document.getElementById('videoElement');
        const status = document.getElementById('status');

        status.innerText = "Loading Stream...";
        
        try {
            const data = await robustFetch(`/streams/${id}`);
            // Find best MP4 (HLS/DASH not supported by basic HTML5 video)
            const stream = data.videoStreams.find(s => s.format === 'MPEG-4' && s.quality === '1080p') 
                        || data.videoStreams.find(s => s.format === 'MPEG-4');
            
            if (stream) {
                videoEl.src = stream.url;
                player.style.display = 'block';
                videoEl.play();
                isPlaying = true;
                videoEl.focus();
                status.innerText = "Playing";
            } else {
                alert("No compatible MP4 stream found.");
            }
        } catch(e) {
            console.error(e);
            alert("Error loading stream.");
        }
    }

    function handlePlayerKeys(e) {
        const videoEl = document.getElementById('videoElement');
        
        // Back / Escape
        if (e.keyCode === 8 || e.keyCode === 27 || e.key === 'Back' || e.key === 'Backspace') {
            e.preventDefault();
            videoEl.pause();
            videoEl.src = "";
            document.getElementById('player').style.display = 'none';
            isPlaying = false;
            // Refocus last card
            const lastCard = document.querySelector('.card:focus') || document.querySelector('.card');
            if(lastCard) lastCard.focus();
        }
        
        // Play/Pause
        if (e.key === 'Enter') {
            videoEl.paused ? videoEl.play() : videoEl.pause();
        }

        // Seek 10s
        if (e.key === 'ArrowRight') videoEl.currentTime += 10;
        if (e.key === 'ArrowLeft') videoEl.currentTime -= 10;
    }

    init();
</script>
</body>
</html>
